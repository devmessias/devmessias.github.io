<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Source Themes Academic 4.8.0"><meta name=author content="Bruno Messias"><meta name=description content="Is python interpreted or compiled? Knowing the nuances of the answer will help us build meta code using AST manipulation at runtime. I'll show you how to construct a decorator that can introspect in the local variables without tracing tricks!"><link rel=alternate hreflang=pt-br href=/pt-br/post/python_ast_and_decorators_with_locals/><link rel=alternate hreflang=en href=/post/python_ast_and_decorators_with_locals/><meta name=theme-color content="#2962ff"><script src=/js/mathjax-config.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css crossorigin=anonymous title=hl-light><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/dracula.min.css crossorigin=anonymous title=hl-dark disabled><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin=anonymous async></script><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js integrity crossorigin=anonymous async></script><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap"><link rel=stylesheet href=/css/academic.css><script async src="https://www.googletagmanager.com/gtag/js?id=UA-178064356-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
function trackOutboundLink(url,target){gtag('event','click',{'event_category':'outbound','event_label':url,'transport_type':'beacon','event_callback':function(){if(target!=='_blank'){document.location=url;}}});console.debug("Outbound link clicked: "+url);}
function onClickCallback(event){if((event.target.tagName!=='A')||(event.target.host===window.location.host)){return;}
trackOutboundLink(event.target,event.target.getAttribute('target'));}
gtag('js',new Date());gtag('config','UA-178064356-1',{});document.addEventListener('click',onClickCallback,false);</script><link rel=manifest href=/index.webmanifest><link rel=icon type=image/png href=/images/icon_hucd6a3d413e7b81060a1d462b35f64cf9_5018_32x32_fill_lanczos_center_2.png><link rel=apple-touch-icon type=image/png href=/images/icon_hucd6a3d413e7b81060a1d462b35f64cf9_5018_192x192_fill_lanczos_center_2.png><link rel=canonical href=/post/python_ast_and_decorators_with_locals/><meta property="twitter:card" content="summary"><meta property="twitter:site" content="@devmessias"><meta property="twitter:creator" content="@devmessias"><meta property="twitter:image" content="https://devmessias.github.io/img/ast_english_sentence.png"><meta property="og:site_name" content="Bruno Messias"><meta property="og:url" content="/post/python_ast_and_decorators_with_locals/"><meta property="og:title" content="Going meta with python: manipulating ASTs to create an introspective decorator at runtime [draft] | Bruno Messias"><meta property="og:description" content="Is python interpreted or compiled? Knowing the nuances of the answer will help us build meta code using AST manipulation at runtime. I'll show you how to construct a decorator that can introspect in the local variables without tracing tricks!"><meta property="og:image" content="/images/icon_hucd6a3d413e7b81060a1d462b35f64cf9_5018_512x512_fill_lanczos_center_2.png"><meta property="og:locale" content="en"><meta property="article:published_time" content="2022-04-08T00:00:00+00:00"><meta property="article:modified_time" content="2022-04-08T00:00:00+00:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"/post/python_ast_and_decorators_with_locals/"},"headline":"Going meta with python: manipulating ASTs to create an introspective decorator at runtime [draft]","datePublished":"2022-04-08T00:00:00Z","dateModified":"2022-04-08T00:00:00Z","author":{"@type":"Person","name":"Bruno Messias"},"publisher":{"@type":"Organization","name":"Bruno Messias","logo":{"@type":"ImageObject","url":"/images/icon_hucd6a3d413e7b81060a1d462b35f64cf9_5018_192x192_fill_lanczos_center_2.png"}},"description":"Is python interpreted or compiled? Knowing the nuances of the answer will help us build meta code using AST manipulation at runtime. I'll show you how to construct a decorator that can introspect in the local variables without tracing tricks!"}</script><title>Going meta with python: manipulating ASTs to create an introspective decorator at runtime [draft] | Bruno Messias</title></head><body id=top class=page-wrapper data-spy=scroll data-offset=70 data-target=#TableOfContents><aside class=search-results id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=#><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><div class=page-header><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Bruno Messias</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Bruno Messias</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/#about><span>About</span></a></li><li class=nav-item><a class=nav-link href=/#posts><span>Recent Posts</span></a></li><li class=nav-item><a class=nav-link href=/#projects><span>Projects</span></a></li><li class=nav-item><a class=nav-link href=/#featured><span>Publications</span></a></li><li class=nav-item><a class="nav-link active" href=/post/><span>Posts</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=Search><i class="fas fa-search" aria-hidden=true></i></a></li><li class="nav-item dropdown i18n-dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><i class="fas fa-globe mr-1" aria-hidden=true></i><span class="d-none d-lg-inline">English</span></a><div class=dropdown-menu><div class="dropdown-item dropdown-item-active"><span>English</span></div><a class=dropdown-item href=/pt-br/post/python_ast_and_decorators_with_locals/><span>Portugu√™s (Brasil)</span></a></div></li></ul></div></nav></div><div id=macaquinho123 class=page-body><div class="container-fluid docs"><div class="row flex-xl-nowrap"><div class="col-12 col-md-10 offset-md-2"><div class=bg-overlay-img style="--bg-url: url(/post/python_ast_and_decorators_with_locals/ast_english_sentence_hue5b8d52ce962721ee6d0acb19268cb10_239788_0x200_resize_lanczos_2.png)"><h1 class=text-left>Going meta with python: manipulating ASTs to create an introspective decorator at runtime [draft]</h1><p class="page-subtitle text-left">Is python interpreted or compiled? Knowing the nuances of the answer will help us build meta code using AST manipulation at runtime.</p><div class=article-metadata><span class=article-date>Apr 8, 2022</span>
<span class=middot-divider></span><a href=/post/python_ast_and_decorators_with_locals/#disqus_thread></a><span class=middot-divider></span><span class=article-categories><i class="fas fa-folder mr-1"></i><a href=/category/python/>Python</a></span></div></div></div></div><div class="row flex-xl-nowrap"><div class="d-none d-md-block col-md-3 docs-toc sidebar-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>Contents</a></li></ul><nav id=TableOfContents><ul><li><ul><li><a href=#intro-our-previous-problem>Intro: our previous problem</a></li><li><a href=#asts-what-they-are>ASTs: What they are?</a></li><li><a href=#python-interpreted-or-compiled>Python: interpreted or compiled?</a></li><li><a href=#extracting-asts-and-interpreting-them>Extracting ASTs and interpreting them</a></li><li><a href=#how-can-i-be-efficient-in-metaprogramming>How can I be efficient in metaprogramming?</a><ul><li><a href=#the-6-simple-steps>The 6 simple steps</a></li></ul></li><li><a href=#creating-our-metaprogramming-function>Creating our metaprogramming function</a><ul><li><a href=#first-six-steps-interaction>First six-steps interaction</a></li><li><a href=#the-nodetransformer-class>The NodeTransformer class</a></li><li><a href=#the-second-six-steps-interaction>The second six-steps interaction</a></li><li><a href=#creating-a-new-function-at-runtime>Creating a new function at runtime</a></li></ul></li><li><a href=#integrating-the-ast-manipulation-with-a-decorator>Integrating the AST manipulation with a decorator</a></li></ul></li></ul></nav></div><main class="col-12 col-md-9 py-md-3 pl-md-5 docs-content" role=main><article class=article><div class=article-container><div class=article-style><details class="toc-inpage d-print-none d-none d-sm-block d-md-none" open><summary class=font-weight-bold>Table of Contents</summary><nav id=TableOfContents><ul><li><ul><li><a href=#intro-our-previous-problem>Intro: our previous problem</a></li><li><a href=#asts-what-they-are>ASTs: What they are?</a></li><li><a href=#python-interpreted-or-compiled>Python: interpreted or compiled?</a></li><li><a href=#extracting-asts-and-interpreting-them>Extracting ASTs and interpreting them</a></li><li><a href=#how-can-i-be-efficient-in-metaprogramming>How can I be efficient in metaprogramming?</a><ul><li><a href=#the-6-simple-steps>The 6 simple steps</a></li></ul></li><li><a href=#creating-our-metaprogramming-function>Creating our metaprogramming function</a><ul><li><a href=#first-six-steps-interaction>First six-steps interaction</a></li><li><a href=#the-nodetransformer-class>The NodeTransformer class</a></li><li><a href=#the-second-six-steps-interaction>The second six-steps interaction</a></li><li><a href=#creating-a-new-function-at-runtime>Creating a new function at runtime</a></li></ul></li><li><a href=#integrating-the-ast-manipulation-with-a-decorator>Integrating the AST manipulation with a decorator</a></li></ul></li></ul></nav></details><h2 id=intro-our-previous-problem>Intro: our previous problem</h2><p>Don&rsquo;t be afraid by the names on the title. Although they can seem scary or strange probably you already have been in touch with tools that work with this kind of stuff. For example, pytest and numba.</p><p>In the previous post, I talked about python frames and inspection module. I&rsquo;ve started showing how we can use the <code>inspect.signature</code> to construct a decorator that validates arguments:</p><pre><code class=language-python>@math_validator()
def simple_method(x: &quot;\in R&quot;, y: &quot;\in R_+&quot;, z: float = 2) -&gt; float:
    ...
simple_method(1, 0)
</code></pre><pre><code>simple_method((1, 2)) -&gt; 1.5
---&gt; 19 simple_method(1, 0)
...
&lt;locals&gt;.decorate.&lt;locals&gt;.decorated(*_args)
     11         continue
     13     if not MATH_SPACES[annotation][&quot;validator&quot;](_args[i]):
---&gt; 14         raise ValueError(f&quot;{k} doesn't belong to the {MATH_SPACES[annotation]['name']}&quot;)
     15 result = func(*_args)
     16 print(f&quot;{func.__name__}({_args}) -&gt; {result}&quot;)

ValueError: y doesn't belong to the space of real numbers greater than zero
</code></pre><p>And after that, I&rsquo;ve combined the <code>inspect.singature</code>+<code>sys.trace</code>+<code>locals</code> to construct a decorator that exposes the local variables of a decorated function. All this stuff allows us to do cool things like creating a generic report decorator that have access to the local variables of the decorated method</p><pre><code class=language-python>@report('{arg.n_bananas} Monkey {gluttonous_monkey} ate too much bananas.  Num monkeys {num_monkeys}')
def feed_monkeys(n_bananas): 
    num_monkeys = 3
    monkeys = {
        f&quot;monkey_{i}&quot;: {&quot;bananas&quot;: 0}
        for i in range(num_monkeys)
    }
    while n_bananas &gt; 0:
        if np.random.uniform() &lt; 0.4:
            continue
        monkey = monkeys[np.random.choice(list(monkeys.keys()))]
        if n_bananas &gt; 0:
            monkey[&quot;bananas&quot;] += 1
            n_bananas -= 1
    gluttonous_monkey = max(monkeys, key=lambda k: monkeys[k][&quot;bananas&quot;]) 
</code></pre><p>These two examples can be found in real application scenarios. But at the end of my previous post I&rsquo;ve told you some issues regarding the use of <code>sys.trace</code>. I&rsquo;ll put the code here of the previous solution:<div class=spoiler><p><a class="btn btn-primary" data-toggle=collapse href=#spoiler-1 role=button aria-expanded=false aria-controls=spoiler-1>Click here to see the solution</a></p><div class="collapse card" id=spoiler-1><div class=card-body><pre><code class=language-python>import sys
import inspect
from types import SimpleNamespace


def call_and_extract_frame(func, *args, **kwargs):
    frame_var = None
    trace = sys.gettrace()
    def update_frame_var(stack_frame, event_name, arg_frame):
        &quot;&quot;&quot;
        Args:
            stack_frame: (frame)
                The current stack frame.
            event_name: (str)
                The name of the event that triggered the call. 
                Can be 'call', 'line', 'return' and 'exception'.
            arg_frame: 
                Depends on the event. Can be a None type
        &quot;&quot;&quot;
        nonlocal frame_var # nonlocal is a keyword which allows us to modify the outisde scope variable
        if event_name != 'call':
            return trace
        frame_var = stack_frame
        sys.settrace(trace)
        return trace
    sys.settrace(update_frame_var)
    try:
        func_result = func(*args, **kwargs)
    finally:
        sys.settrace(trace)
    return frame_var, func_result
def report(formater):
    def decorate(func):
        def decorated(*_args):
            sig = inspect.signature(func)
            named_args = {}
            num_args = len(_args)
            for i, (k, v) in enumerate(sig.parameters.items()):
                if i &lt; num_args:
                    named_args[k] = repr(_args[i])
                else:
                    named_args[k] = repr(v.default)
            frame_func, _result = call_and_extract_frame(func, *_args)
            name = func.__name__
            result = repr(_result)
            
            args_dict = {
                &quot;args&quot;: SimpleNamespace(**named_args), 
                &quot;args_repr&quot;: repr(SimpleNamespace(**named_args)),
                **locals(),
                **frame_func.f_locals,
            }
            print(formater.format(**args_dict))
            # do other stuff here
            return _result 
        return decorated
    return decorate
</code></pre></div></div></div></p><p>What are the problems with this solution?</p><ul><li>A tracing always creates a cost. Thus, is expected that we will reduce the performance of our system. If you use this just for debugging purposes, it&rsquo;s ok.</li><li>This can create conflicts with other tools and libs that also trying to use the trace tool</li><li>it seems dirty!</li></ul><p>Ok, maybe you&rsquo;re asking yourself <em>&ldquo;This guy is overthinking. Why he didn&rsquo;t just do this?"</em></p><pre><code class=language-python>@report('stuff goes here')
def func(x, y):
    random_var = np.random.uniform()
    ... #more local vars
    result = (x+y)**random_var
    return result, locals 
</code></pre><p><em>&rdquo;&mldr;and then, inside of decorator change to this:"</em></p><pre><code class=language-python>_result, local_vars = func(x, y)
</code></pre><p>The reason is:</p><ul><li>The main point of using this decorator is to avoid any change in other parts of the codebase. For example,
if in any part of the codebase <code>func</code> has been called you will have to change to</li></ul><pre><code class=language-python>result = func(x, y) # to 
result = func(x, y)[0]
</code></pre><p>If after you choose to remove the decorator from a function, you will need to be rollback all the above changes.</p><ul><li>You will increase the cognitive load in all members of the team who doesn&rsquo;t care about what your decorator needs to do.</li><li>If you propose this a solution is better just to create another function and face the consequences of this increase in complexity in the original codebase.</li></ul><p>Ok, maybe you&rsquo;re now thinking: &ldquo;<em>Right, this makes sense, but you&rsquo;re avoiding theses issues creating issues in performance and debugging. Don&rsquo;t sound good besides for just some special cases</em>&rdquo;. And I need to agree with you, <strong>it&rsquo;s not a good solution for most of the cases!</strong></p><p>Well, what can I do? The problem we&rsquo;re facing is that python doesn&rsquo;t have context managers that can deal with namespaces. Although there is an active discussion about this
<a href=https://mail.python.org/archives/list/python-ideas@python.org/thread/TAVHEKDZVYKJUGZKWSVZVAOGBPLZVKQG/ target=_blank rel=noopener>https://mail.python.org/archives/list/python-ideas@python.org/</a>. But don&rsquo;t worry about this big name. The important point here is that:</p><div class="alert alert-note"><div><strong>If a language doesn&rsquo;t have a feature that I need what can I do?</strong></div></div><p>In python we are fine with this because it&rsquo;s a language that turns to be easy to manipulate what is called <strong>A</strong>bstract <strong>S</strong>yntax <strong>T</strong>ree and recompile a function with the manipulated syntax tree. <strong>Doing that way we&rsquo;re in the realm of metaprogramming. Writing code which writes code.</strong> If t&rsquo;s not clear I&rsquo;ll try to be more clear now.</p><h2 id=asts-what-they-are>ASTs: What they are?</h2><p>A programming language obviously is at least a language. OK, <strong>but what is a language?
Do all the human languages share the same building blocks? How can we compare different sentences?</strong>
These questions seem more proper to be answered by philosophers. Well, maybe this is true, but these questions can also be answered by mathematicians and computer scientists. Although, mathematicians and CS people usually prefer to talk using mathematical formalism rather than long debates about the meaning of the stuff. In essence, an <strong>AST</strong> is a mathematical formalism that allows us to represent a sentence using a well-defined set of rules and structures represented by a tree.</p><h3>How do you know that a sentence is grammatically correct?</h3><p>Intuitively, probably you remember a set of rules that you learned during your life about how to organize and compose verbs, nouns, adjectives, adverbs, etc. This set of rules and guidelines is the <em>Syntax</em> of a language. A <strong>S</strong>yntax <strong>T</strong>ree is a structure that helps us to understand a sentence.</p><div class="alert alert-note"><div>After constructing the syntax tree we can look in the guidelines book of our language and check if this tree has a valid structure.</div></div><p>Take for example
the sentence: <em>&ldquo;I drive a car to my college&rdquo;</em>, the syntax tree is the following:</p><figure id=figure-a-syntax-tree-for-the-sentence-i-drive-a-car-to-my-college-source-geeks-for-geekssyntax-tree--natural-language-processinghttpswwwgeeksforgeeksorgsyntax-tree-natural-language-processing><a data-fancybox href=/post/python_ast_and_decorators_with_locals/ast_english_sentence_hue5b8d52ce962721ee6d0acb19268cb10_239788_0x400_resize_lanczos_2.png data-caption='A <strong>S</strong>yntax <strong>T</strong>ree for the sentence: <em>I drive a car to my college</em>. <strong>Source</strong>:<a href="https://www.geeksforgeeks.org/syntax-tree-natural-language-processing/"> Geeks for Geeks:Syntax Tree ‚Äì Natural Language Processing.</a>'><img src=/post/python_ast_and_decorators_with_locals/ast_english_sentence_hue5b8d52ce962721ee6d0acb19268cb10_239788_0x400_resize_lanczos_2.png alt height=400px></a><figcaption>A <strong>S</strong>yntax <strong>T</strong>ree for the sentence: <em>I drive a car to my college</em>. <strong>Source</strong>:<a href=https://www.geeksforgeeks.org/syntax-tree-natural-language-processing/> Geeks for Geeks:Syntax Tree ‚Äì Natural Language Processing.</a></figcaption></figure><p>What is the advantage of using ASTs? Notice that we don&rsquo;t need to talk about how many spaces you&rsquo;re using, we didn&rsquo;t talk about your calligraphy and besides that, <strong>we have a hierarchy structure that allows us to analyze the validity of the sentence per level! If we want to change any element of the sentence we can directly manipulate the node which represents that element for a safe guarantee that the manipulated sentence is still grammatically correct!</strong></p><p>It&rsquo;s not a surprise that ASTs are also a common tool used in computer science to analyze the correctness of a piece of code and as a common part of the process of compiling/interpreting a code. Here we will extend the behavior of a python decorator manipulating the AST. But before that, I would like to ask you a question:</p><h5 class=text-center>Is Python an interpreted language?</h5><h2 id=python-interpreted-or-compiled>Python: interpreted or compiled?</h2><p>Usually, when I meet a python hater (or even an enthusiast) they say phrases like that</p><ul><li><em>&ldquo;Python is slow because it&rsquo;s an interpreted language!"</em></li><li><em>&ldquo;Python sucks because doesn&rsquo;t have a compiler!"</em></li></ul><p>Well, these assertions are not true. The important point is that: <em>when people refer to python commonly they are actually talking about the language python and the CPython virtual machine</em>. Let&rsquo;s talk more about these misconceptions.</p><p>First, the distinction between interpreted and compiled languages is very blurry today.
Second, let&rsquo;s see a nasty thing</p><pre><code class=language-python>hello_world = &quot;print('Hello, world!')&quot;
hello_world_obj = compile(hello_world, '&lt;string&gt;', 'single')
</code></pre><p>Yeah, if you&rsquo;re trying to defend that python is interpreted the things start to get more hard for you. <strong>Why is there a <strong>compile</strong> available?</strong></p><pre><code class=language-python>exec(hello_world_obj)
</code></pre><pre><code>Hello, world!
</code></pre><p>I&rsquo;m executing a thing that has been compiled??? What is this hello_world_obj?</p><pre><code class=language-python>print(f&quot;Bad news for you:\n\tContent: {hello_world_obj.co_code}\n\tType: {type(hello_world_obj.co_code)}&quot;)
</code></pre><pre><code>Bad news for you:
	Content: b'e\x00d\x00\x83\x01F\x00d\x01S\x00'
	Type: &lt;class 'bytes'&gt;
</code></pre><p>But what is this stuff?</p><p>Is important to understand what happens behind the scenes.</p><p>After you write a python code and call the python command, python starts a compiling phase creating the ASTs; generating the bytecotes that will be attached to <strong>code objects</strong>, and then, these code objects will be interpreted by the CPython virtual machine. The diagram below is a simple representation of this process with some details hidden</p><div class="mermaid mermaidContainer">graph LR;
A[Source Code]-->|parsing|B[Parse Tree];
B-->C[AST];
C-->E[Bytecode];
E-->F[Code Object];
F-->|execution by|G[CPython Virtual Machine];</div><p>The compilation phase are the firts steps of the above diagram</p><div class="mermaid mermaidContainer">graph LR;
A[Source Code]-->|parsing|B[Parse Tree];
B-->C[AST];
C-->E[Bytecode];
E-->F[Code Object];</div><p>But don&rsquo;t worry about most of the big names above. The only concepts that will matter to us are the AST, bytecodes, and Code object.
<strong>Bytecodes are just a compact way to tell the interpreter what we want to do.
The code object is just a way to encapsulate the bytecodes extracted from the AST.</strong></p><p>But how does this help us?</p><div class="alert alert-note"><div>Our solution will involve the manipulation of the AST and after that generating a new code object with the related manipulated AST!</div></div><blockquote><p>A funny history from Luciano Ramalho:<blockquote class=twitter-tweet><p lang=en dir=ltr>In 2018 I told a CBP officer I was entering the US to speak at PyCon. He asked: "Is Python interpreted or compiled?" After a 2 second pause I said "Interpreted". I didn't give the correct answer because I didn't want to extend the "pleasant" conversation. He let me in.</p>&mdash; Luciano Ramalho ‚òî üêç ‚öó ‚ñ∂Ô∏èüò∑üíâüíâüíâ (@ramalhoorg) <a href="https://twitter.com/ramalhoorg/status/1474044907585167362?ref_src=twsrc%5Etfw">December 23, 2021</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script></p></blockquote><h2 id=extracting-asts-and-interpreting-them>Extracting ASTs and interpreting them</h2><p>Let&rsquo;s see a simple example of a function and the extracted AST.</p><pre><code class=language-python>import inspect
import ast
import astor # install this for pretty printing
def example(a: float, b:float = 2) -&gt; float:
    s = a+b
    return s

tree = ast.parse(inspect.getsource(example))
print(astor.dump(tree))
astor.to_source(tree)
</code></pre><pre><code>Module(
    body=[
        FunctionDef(name='example',
            args=arguments(posonlyargs=[],
                args=[arg(arg='a', annotation=Name(id='float'), type_comment=None),
                    arg(arg='b', annotation=Name(id='float'), type_comment=None)],
                vararg=None,
                kwonlyargs=[],
                kw_defaults=[],
                kwarg=None,
                defaults=[Constant(value=2, kind=None)]),
            body=[
                Assign(targets=[Name(id='s')],
                    value=BinOp(left=Name(id='a'), op=Add, right=Name(id='b')),
                    type_comment=None),
                Return(value=Name(id='s'))],
            decorator_list=[],
            returns=Name(id='float'),
            type_comment=None)],
    type_ignores=[])
</code></pre><p>The above output is our AST, take some time looking into it to see how all our code stuff is organized.
The image below shows the graph representation of the above output</p><figure><a data-fancybox href=/post/python_ast_and_decorators_with_locals/simple_ast_hudca446749283cbe6d28b67a245474890_120568_0x1000_resize_lanczos_2.png><img src=/post/python_ast_and_decorators_with_locals/simple_ast_hudca446749283cbe6d28b67a245474890_120568_0x1000_resize_lanczos_2.png alt height=400px></a></figure><p>Each element in the above output with an upper case letter is a <strong>node</strong> (Name, BinOp, FunctionDef, etc) from the base class <code>ast.Node</code>. One of the most important node types are the <code>ast.Name</code>.
For example,</p><pre><code>value=BinOp(left=Name(id='a'), op=Add, right=Name(id='b')),
</code></pre><p>the <code>ast.Name</code> is used to refer a variable by the name, <code>id</code>.</p><p>Now let&rsquo;s come back to our problem. Remember that one bad solution it was rewriting every function</p><pre><code class=language-python>def func(x, y):
    random_var = np.random.uniform()
    ... #more local vars
    result = (x+y)**random_var
    return result
</code></pre><p>as</p><pre><code class=language-python>def func_transformed(x, y):
    random_var = np.random.uniform()
    ... #more local vars
    result = (x+y)**random_var
    return result, locals 
</code></pre><p>The big stuff that we will do is to <strong>write a function that codes new functions for us! This is metaprogramming!</strong> And at same time we will write a decorator that will avoid any change in our codebase!</p><h2 id=how-can-i-be-efficient-in-metaprogramming>How can I be efficient in metaprogramming?</h2><p>We must create a function that generates a new one similar to <code>func_transformed</code>. How to get an idea of what we need to do?</p><h3 id=the-6-simple-steps>The 6 simple steps</h3><ol><li>Create an example function</li><li>Code the transformed function from the example function</li><li>Code a simple test to check if the transformed function is correct</li><li>Extract the AST from the example and the transformed function</li><li>Compare the ASTs. What is the difference? Annotate this difference somewhere<ul><li>You can use the <code>difflib</code> module that comes with python to diff strings</li></ul></li><li>Creates a new and more complex example function and repeats the process until you get a good idea of what you need to do.</li></ol><p>After you have a good idea of what you need to do, you can start writing your metaprogramming function.</p><h2 id=creating-our-metaprogramming-function>Creating our metaprogramming function</h2><h3 id=first-six-steps-interaction>First six-steps interaction</h3><p>Let&rsquo;s start our first interaction writing one function, the expected transformed function and the test to check if it is correct.</p><pre><code class=language-python>def example_1(x, y):
    internal_var  =  222
    result = (x+y)**internal_var
    return result
def example_1_expected(x, y):
    internal_var = 222
    result = (x+y)**internal_var
    return result, locals()

def test_meta_example_1(meta_func, x, y):
    expected_result, expected_locals = example_1_expected(x, y)
    result, locals_dict = meta_func(x, y)
    assert result == expected_result
    assert expected_locals == locals_dict
</code></pre><p>Everything looks fine. Now we will use the <code>difflib</code> to see the differences between the two ASTs.</p><pre><code class=language-python>import difflib
from pprint import pprint

example_1_ast_str = astor.dump_tree(ast.parse(inspect.getsource(example_1)))
example_1_expected_str = astor.dump_tree(ast.parse(inspect.getsource(example_1_expected)))


pprint(
    list(
        difflib.unified_diff(example_1_ast_str.splitlines(), example_1_expected_str.splitlines(), n=0)
    )
)
</code></pre><pre><code>['--- \n',
 '+++ \n',
 '@@ -3 +3 @@\n',
 &quot;-        FunctionDef(name='example_1',&quot;,
 &quot;+        FunctionDef(name='example_1_expected',&quot;,
 '@@ -19 +19 @@\n',
 &quot;-                Return(value=Name(id='result'))],&quot;,
 &quot;+                Return(value=Tuple(elts=[Name(id='result'), &quot;
 &quot;Call(func=Name(id='locals'), args=[], keywords=[])]))],&quot;]
</code></pre><p>Now we know that we must change this Node in the AST</p><pre><code>Return(value=Name(id='result'))],
</code></pre><p>To this</p><pre><code>Return(value=Tuple(elts=[Name(id='result'), Call(func=Name(id='locals'), args=[], keywords=[])]))],
</code></pre><p>How we can do this? With the help of <code>NodeTransformer</code> class</p><h3 id=the-nodetransformer-class>The NodeTransformer class</h3><p>The <code>ast.NodeTransformer</code> allows us to create objects with a walker-like interface. The walker will visit each node in the AST and during each visit, the walker can remove, replace, modify or add nodes, and after that, he can continue to walk to the childreens of the node or stop there.</p><p>How can we use this?
First, we start by creating a new class derived from <code>ast.NodeTransformer</code></p><pre><code class=language-python>class ASTTransformer(ast.NodeTransformer):
    def visit_Return(self, node):
</code></pre><p>If you want to interact/change/delete a node of type <code>Something</code> you must override the <code>visit_Something</code> method. Thus, because we need to change the <code>Return</code> node we override the <code>visit_Return</code>. If we do just the following, our walker will not change our AST,</p><pre><code class=language-python>class ASTTransformer(ast.NodeTransformer):
    ...
</code></pre><p>Let&rsquo;s start the modifications. We need to create a new node responsible to call the <code>locals</code></p><pre><code class=language-python>class ASTTransformer(ast.NodeTransformer):
    def visit_Return(self, node):
        node_locals = ast.Call(
            func=ast.Name(id='locals', ctx=ast.Load()),
            args=[], keywords=[]
        )
        self.generic_visit(node)
        return node
</code></pre><p>We used a <code>Name</code> node to identify the <code>locals</code> function. Now, according to the diff result our <code>Return</code> node must be transformed into a <code>Return</code> of a Tuple node</p><pre><code class=language-python>class ASTTransformer(ast.NodeTransformer):
    def visit_Return(self, node):
        node_locals = ast.Call(
            func=ast.Name(id='locals', ctx=ast.Load()),
            args=[], keywords=[]
        )
        new_node.value = ast.Tuple(
            elts=[
                node.value,
                node_locals
            ],
            ctx=ast.Load()
        )
        self.generic_visit(new_node)
        return new_node
</code></pre><p>A new thing appeared. The <code>elts</code> argument. But don&rsquo;t worry, this is just an argument which tells what is the list of other nodes <code>Tuple</code> has. Whenever you have some doubt about AST stuff, you can check the <code>ast</code> documentation
<a href=https://docs.python.org/3/library/ast.html target=_blank rel=noopener>here</a>. The documentation is simple to understand because python is simple!</p><p>Everything is almost done. The last thing is to fix our AST. Because when we change the Node we need to fill missing information like the line_number and column_offset. Thanks to python we just need to call <code>fix_missing_locations</code> to fill this for us.</p><pre><code class=language-python>
class ASTTransformer(ast.NodeTransformer):
    def visit_Return(self, node):
        new_node = node
        node_locals = ast.Call(
            func=ast.Name(id='locals', ctx=ast.Load()),
            args=[], keywords=[]
        )
        new_node.value = ast.Tuple(
            elts=[
                node.value,
                node_locals
            ],
            ctx=ast.Load()
        )
        ast.copy_location(new_node, node)
        ast.fix_missing_locations(new_node)
        self.generic_visit(new_node)
        return new_node
</code></pre><p>Ok, let&rsquo;s see if is working. We must instantiate our transformer and call the <code>visit</code> method that tells the walker to walk in the AST and do all the modification we&rsquo;re asking</p><pre><code class=language-python>tree_meta = ast.parse(inspect.getsource(example_1))
transformer = ASTTransformer()
transformer.visit(tree_meta)
example_1_meta_ast_str = astor.dump_tree(tree_meta)
example_1_expected_str = astor.dump_tree(ast.parse(inspect.getsource(example_1_expected)))


pprint(
    list(
        difflib.unified_diff(example_1_meta_ast_str.splitlines(), example_1_expected_str.splitlines(), n=0)
    )
)
</code></pre><pre><code>['--- \n',
 '+++ \n',
 '@@ -3 +3 @@\n',
 &quot;-        FunctionDef(name='example_1',&quot;,
 &quot;+        FunctionDef(name='example_1_expected',&quot;]
</code></pre><p>Our first iteration was successful! Let&rsquo;s try a more complex example.</p><h3 id=the-second-six-steps-interaction>The second six-steps interaction</h3><p>We&rsquo;ll just add more complexity without any particular meaning, we can be creative!</p><pre><code class=language-python>def example_2(x, y):
    internal_var  =  222
    def sub(x, y):
        ommit_this_var = 1
        return x - y
    result = sub(x,y)**internal_var
    return (result, False)
def example_2_expected(x, y):
    internal_var  =  222
    def sub(x, y):
        ommit_this_var = 1
        return x - y
    result = sub(x,y)**internal_var
    return ((result, False), locals())
def test_meta_example_2(meta_func, x, y):
    expected_result, expected_locals = example_2_expected(x, y)
    result, locals_dict = meta_func(x, y)
    del locals_dict[&quot;sub&quot;]
    del expected_locals[&quot;sub&quot;]
    assert result == expected_result
    assert expected_locals == locals_dict
</code></pre><pre><code class=language-python>example_2_ast_str = astor.dump_tree(ast.parse(inspect.getsource(example_2)))
example_2_expected_str = astor.dump_tree(ast.parse(inspect.getsource(example_2_expected)))


pprint(
    list(
        difflib.unified_diff(example_2_ast_str.splitlines(), example_2_expected_str.splitlines(), n=0)
    )
)
</code></pre><pre><code>['--- \n',
 '+++ \n',
 '@@ -3 +3 @@\n',
 &quot;-        FunctionDef(name='example_2',&quot;,
 &quot;+        FunctionDef(name='example_2_expected',&quot;,
 '@@ -37 +37,4 @@\n',
 &quot;-                Return(value=Tuple(elts=[Name(id='result'), &quot;
 'Constant(value=False, kind=None)]))],',
 '+                Return(',
 '+                    value=Tuple(',
 &quot;+                        elts=[Tuple(elts=[Name(id='result'), &quot;
 'Constant(value=False, kind=None)]),',
 &quot;+                            Call(func=Name(id='locals'), args=[], &quot;
 'keywords=[])]))],']
</code></pre><p>Now, it&rsquo;s time to cross the fingers and see if we need working more</p><pre><code class=language-python>tree_meta = ast.parse(inspect.getsource(example_2))
transformer = ASTTransformer()
transformer.visit(tree_meta)
example_2_meta_ast_str = astor.dump_tree(tree_meta)
example_2_expected_str = astor.dump_tree(ast.parse(inspect.getsource(example_2_expected)))


pprint(
    list(
        difflib.unified_diff(example_2_meta_ast_str.splitlines(), example_2_expected_str.splitlines(), n=0)
    )
)
</code></pre><pre><code>['--- \n',
 '+++ \n',
 '@@ -3 +3 @@\n',
 &quot;-        FunctionDef(name='example_2',&quot;,
 &quot;+        FunctionDef(name='example_2_expected',&quot;,
 '@@ -27,4 +27 @@\n',
 '-                        Return(',
 '-                            value=Tuple(',
 &quot;-                                elts=[BinOp(left=Name(id='x'), op=Sub, &quot;
 &quot;right=Name(id='y')),&quot;,
 &quot;-                                    Call(func=Name(id='locals'), args=[], &quot;
 'keywords=[])]))],',
 &quot;+                        Return(value=BinOp(left=Name(id='x'), op=Sub, &quot;
 &quot;right=Name(id='y')))],&quot;]
</code></pre><p>Unfortunately, our <code>ASTTransformer</code> was not able to deal with this crazy guy. What is the problem? If you check carefully you will notice that the inner function <code>def sub</code> is the problem. We don&rsquo;t want to change any &ldquo;sub&rdquo; function, so we need to tell our walker to avoid changing this kind of stuff. To do so, we will create a flag to tell if the walker is in a sub-function, and we will just override the <code>visit_FunctionDef</code> method to check this flag</p><pre><code class=language-python>class ASTTransformer(ast.NodeTransformer):
    def visit_FunctionDef(self, node):
        if self._sub:
            return node
        self._sub = True
        self.generic_visit(node)
        return node

    def visit_Module(self, node):
        self._sub = 0
        self.generic_visit(node)

    def visit_Return(self, node):
        new_node = node
        node_locals = ast.Call(
            func=ast.Name(id='locals', ctx=ast.Load()),
            args=[], keywords=[]
        )
        new_node.value = ast.Tuple(
            elts=[
                node.value,
                node_locals
            ],
            ctx=ast.Load()
        )
        ast.copy_location(new_node, node)
        ast.fix_missing_locations(new_node)
        self.generic_visit(new_node)
        return new_node 
</code></pre><pre><code class=language-python>tree_meta = ast.parse(inspect.getsource(example_2))
transformer = ASTTransformer()
transformer.visit(tree_meta)
example_2_meta_ast_str = astor.dump_tree(tree_meta)
example_2_expected_str = astor.dump_tree(ast.parse(inspect.getsource(example_2_expected)))


pprint(
    list(
        difflib.unified_diff(example_2_meta_ast_str.splitlines(), example_2_expected_str.splitlines(), n=0)
    )
)
</code></pre><pre><code>['--- \n',
 '+++ \n',
 '@@ -3 +3 @@\n',
 &quot;-        FunctionDef(name='example_2',&quot;,
 &quot;+        FunctionDef(name='example_2_expected',&quot;]
</code></pre><p>Our new <code>ASTTransformer</code> was able to deal with our new complicated example!</p><h3 id=creating-a-new-function-at-runtime>Creating a new function at runtime</h3><p>We have a <code>ASTTransformer</code> , now we must compile the transformed <code>AST</code> into a new function. In python, we can create a new function using the <code>FunctionType</code>, see below</p><pre><code class=language-python>from types import FunctionType, CodeType

def transform_and_compile(func: FunctionType)-&gt;FunctionType:
    source = inspect.getsource(func)
    # we put this to remove the line from source code with the decorator
    source = &quot;\n&quot;.join([l for l in source.splitlines() if not l.startswith(&quot;@&quot;)])
    tree = ast.parse(source)
    transformer = ASTTransformer()
    transformer.visit(tree)
    code_obj = compile(tree, func.__code__.co_filename, 'exec')
    function_code = [c for c in code_obj.co_consts if isinstance(c, CodeType)][0]
    # we must to pass the globals context to the function
    transformed_func = FunctionType(function_code, func.__globals__)
    return transformed_func
</code></pre><pre><code class=language-python>test_meta_example_1(transform_and_compile(example_1), 4, 2)
test_meta_example_2(transform_and_compile(example_2), 1, 2)

</code></pre><p>The <code>transform_and_compile</code> was able to create new functions that passed in all the tests! We can now move further to the final and easy step which is just to integrate this function with our decorator!</p><h2 id=integrating-the-ast-manipulation-with-a-decorator>Integrating the AST manipulation with a decorator</h2><p>We will call the <code>transform_and_compile</code> right after the <code>def decorate</code> to avoid unnecessary compilations every time that the decorated function is called.</p><pre><code class=language-python>def report(fmt):
    def decorate(func):
        meta_func = transform_and_compile(func)
        ....
</code></pre><p>Inside <code>def decorated</code> we call the <code>meta_func</code> and return just the result because we don&rsquo;t want to change our codebase.</p><pre><code class=language-python>def report(fmt):
    def decorate(func):
        meta_func = transform_and_compile(func)
        ...
        def decorated(*_args):
            _result, internal_locals = meta_func(*_args)
            ....
            return _result
</code></pre><p>With all the stuff we learned in the previous post our <code>report</code> decorator with the above changes will be</p><pre><code class=language-python>
def report(fmt):
    def decorate(func):
        meta_func = transform_and_compile(func)
        sig = inspect.signature(func)
        def decorated(*_args):
            _result, internal_locals = meta_func(*_args)
            named_args = {}
            num_args = len(_args)
            for i, (k, v) in enumerate(sig.parameters.items()):
                if i &lt; num_args:
                    named_args[k] = repr(_args[i])
                else:
                    named_args[k] = repr(v.default)
            
            name = func.__name__
            result = repr(_result)
            args_dict = {
                **internal_locals,
                **locals(),
                **named_args
            }
            print(fmt.format(**args_dict))
            # store the information in some place
            return result
        return decorated 
    return decorate
</code></pre><p>Let&rsquo;s see the result with a dummy function</p><pre><code class=language-python>@report(fmt='{name}(a={a}, b={b}, c={c}); sum_ab {sum_ab}, diff_ab {dif_ab}; r={result}')
def dummy_example(a, b, c=2):
    sum_ab = a + b
    dif_ab = a - b
    r = sum_ab**c + dif_ab**c
    return r

r = dummy_example(2, 3, 1)
print(&quot;r:&quot;, r)
</code></pre><pre><code>dummy_example(a=2, b=3, c=1); sum_ab 5, diff_ab -1; r=4
r: 4
</code></pre><p>I know this post is quite hard to read, but I think it&rsquo;s worth to share it. I hope you enjoyed it!</p></div><div class=article-tags><a class="badge badge-light" href=/tag/python/>python</a>
<a class="badge badge-light" href=/tag/ast/>ast</a>
<a class="badge badge-light" href=/tag/compilers/>compilers</a>
<a class="badge badge-light" href=/tag/decorators/>decorators</a>
<a class="badge badge-light" href=/tag/debugging/>debugging</a>
<a class="badge badge-light" href=/tag/hacks/>hacks</a></div><div class=share-box aria-hidden=true><h5 class=text-center>Share this page if you like it</h5><ul class=share><li><a href="https://twitter.com/intent/tweet?url=/post/python_ast_and_decorators_with_locals/&text=Going%20meta%20with%20python:%20manipulating%20ASTs%20to%20create%20an%20introspective%20decorator%20at%20runtime%20[draft]" target=_blank rel=noopener class=share-btn-twitter><i class="fab fa-twitter"></i></a></li><li><a href="https://www.facebook.com/sharer.php?u=/post/python_ast_and_decorators_with_locals/&t=Going%20meta%20with%20python:%20manipulating%20ASTs%20to%20create%20an%20introspective%20decorator%20at%20runtime%20[draft]" target=_blank rel=noopener class=share-btn-facebook><i class="fab fa-facebook"></i></a></li><li><a href="mailto:?subject=Going%20meta%20with%20python:%20manipulating%20ASTs%20to%20create%20an%20introspective%20decorator%20at%20runtime%20[draft]&body=/post/python_ast_and_decorators_with_locals/" target=_blank rel=noopener class=share-btn-email><i class="fas fa-envelope"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?url=/post/python_ast_and_decorators_with_locals/&title=Going%20meta%20with%20python:%20manipulating%20ASTs%20to%20create%20an%20introspective%20decorator%20at%20runtime%20[draft]" target=_blank rel=noopener class=share-btn-linkedin><i class="fab fa-linkedin-in"></i></a></li><li><a href="whatsapp://send?text=Going%20meta%20with%20python:%20manipulating%20ASTs%20to%20create%20an%20introspective%20decorator%20at%20runtime%20[draft]%20/post/python_ast_and_decorators_with_locals/" target=_blank rel=noopener class=share-btn-whatsapp><i class="fab fa-whatsapp"></i></a></li><li><a href="https://service.weibo.com/share/share.php?url=/post/python_ast_and_decorators_with_locals/&title=Going%20meta%20with%20python:%20manipulating%20ASTs%20to%20create%20an%20introspective%20decorator%20at%20runtime%20[draft]" target=_blank rel=noopener class=share-btn-weibo><i class="fab fa-weibo"></i></a></li></ul></div><div class="media author-card content-widget-hr"><img class="avatar mr-3 avatar-circle" src=/author/bruno-messias/avatar_hu8c5dc81c7296f83357bec0b4ab814f69_6046_270x270_fill_lanczos_center_2.png alt="Bruno Messias"><div class=media-body><h5 class=card-title><a href=/>Bruno Messias</a></h5><h6 class=card-subtitle>Ph.D Candidate/Software Developer</h6><p class=card-text>Free-software enthusiast, researcher, and software developer. Currently, working in the field of Graphs, Complex Systems and Machine Learning.</p><ul class=network-icon aria-hidden=true><li><a href=mailto:devmessias@gmail.com><i class="fas fa-envelope"></i></a></li><li><a href=https://twitter.com/devmessias target=_blank rel=noopener><i class="fab fa-twitter"></i></a></li><li><a href=https://github.com/devmessias target=_blank rel=noopener><i class="fab fa-github"></i></a></li><li><a href=https://www.linkedin.com/in/bruno-messias-510553193/ target=_blank rel=noopener><i class="fab fa-linkedin"></i></a></li></ul></div></div><section id=comments><div id=disqus_thread></div><script>let disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='https://'+"devmessias"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section><div class="article-widget content-widget-hr"><h3>Related</h3><ul><li><a href=/post/python_decorator_that_exposes_locals/>An introspective python decorator using stack frames and the inspect module</a></li><li><a href=/post/using_lsof_and_strace_to_investigate_process_and_failures/>Dissecting processes and failures in Linux with lsof and strace: cases for MlOps and DevOps</a></li><li><a href=/post/edge_graph_filtering/>Grafos e filtragem de arestas: conceitos e confus√µes. Parte I</a></li><li><a href=/post/random_matrix_portfolio/>Varia√ß√µes do teorema central do limite para matrizes aleat√≥rias.</a></li><li><a href=/project/helios/>Helios: graph layout viz and streaming</a></li></ul></div></div></article></main></div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.8/mermaid.min.js integrity="sha256-lyWCDMnMeZiXRi7Zl54sZGKYmgQs4izcT7+tKc+KUBk=" crossorigin=anonymous title=mermaid></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/r.min.js></script><script>const code_highlighting=true;</script><script>const isSiteThemeDark=false;</script><script>const search_config={"indexURI":"/index.json","minLength":1,"threshold":0.3};const i18n={"no_results":"No results found","placeholder":"Search...","results":"results found"};const content_type={'post':"Posts",'project':"Projects",'publication':"Publications",'talk':"Talks",'slides':"Slides"};</script><script id=search-hit-fuse-template type=text/x-template>
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script><script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin=anonymous></script><script id=dsq-count-scr src=https://devmessias.disqus.com/count.js async></script><script src=/js/academic.min.37431be2d92d7fb0160054761ab79602.js></script><div class=page-footer><div class=container><footer class=site-footer><p class=powered-by><a href=/privacy/>Privacy Policy</a>
&#183;
<a href=/terms/>Terms</a></p><p class=powered-by>Bruno Messias</p><p class=powered-by>Powered by the
<a href=https://sourcethemes.com/academic/ target=_blank rel=noopener>Academic theme</a> for
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a>.
<span class=float-right aria-hidden=true><a href=# class=back-to-top><span class=button_icon><i class="fas fa-chevron-up fa-2x"></i></span></a></span></p></footer></div></div><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i>Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i>Download</a><div id=modal-error></div></div></div></div></div></body></html>