<!doctype html><html lang=pt-br><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Source Themes Academic 4.8.0"><meta name=author content="Bruno Messias"><meta name=description content="Python √© interpretado ou compilado? Conhecer as sutilezas da resposta para essa pergunta nos ajudar√° a entender e escrever um c√≥digo que escreve fun√ß√µes em tempo de execu√ß√£o (runtime) . Nosso exemplo ser√° um decorador que tem acesso ao locals de uma fun√ß√£o decorada sem usar truques com trace."><link rel=alternate hreflang=en href=/post/python_ast_metaprogramming_with_introspection_and_decorators/><link rel=alternate hreflang=pt-br href=/pt-br/post/python_ast_metaprogramming_with_introspection_and_decorators/><meta name=theme-color content="#2962ff"><script src=/js/mathjax-config.js></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css crossorigin=anonymous title=hl-light><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/dracula.min.css crossorigin=anonymous title=hl-dark disabled><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin=anonymous async></script><script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js integrity crossorigin=anonymous async></script><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap"><link rel=stylesheet href=/css/academic.css><script async src="https://www.googletagmanager.com/gtag/js?id=UA-178064356-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
function trackOutboundLink(url,target){gtag('event','click',{'event_category':'outbound','event_label':url,'transport_type':'beacon','event_callback':function(){if(target!=='_blank'){document.location=url;}}});console.debug("Outbound link clicked: "+url);}
function onClickCallback(event){if((event.target.tagName!=='A')||(event.target.host===window.location.host)){return;}
trackOutboundLink(event.target,event.target.getAttribute('target'));}
gtag('js',new Date());gtag('config','UA-178064356-1',{});document.addEventListener('click',onClickCallback,false);</script><link rel=manifest href=/pt-br/index.webmanifest><link rel=icon type=image/png href=/images/icon_hucd6a3d413e7b81060a1d462b35f64cf9_5018_32x32_fill_lanczos_center_2.png><link rel=apple-touch-icon type=image/png href=/images/icon_hucd6a3d413e7b81060a1d462b35f64cf9_5018_192x192_fill_lanczos_center_2.png><link rel=canonical href=/pt-br/post/python_ast_metaprogramming_with_introspection_and_decorators/><meta property="twitter:card" content="summary"><meta property="twitter:site" content="@devmessias"><meta property="twitter:creator" content="@devmessias"><meta property="twitter:image" content="https://devmessias.github.io/img/ast_english_sentence.png"><meta property="og:site_name" content="Bruno Messias"><meta property="og:url" content="/pt-br/post/python_ast_metaprogramming_with_introspection_and_decorators/"><meta property="og:title" content="Metaprogram√ß√£o em Python com ASTs: criando um decorador com introspec√ß√£o [Draft] | Bruno Messias"><meta property="og:description" content="Python √© interpretado ou compilado? Conhecer as sutilezas da resposta para essa pergunta nos ajudar√° a entender e escrever um c√≥digo que escreve fun√ß√µes em tempo de execu√ß√£o (runtime) . Nosso exemplo ser√° um decorador que tem acesso ao locals de uma fun√ß√£o decorada sem usar truques com trace."><meta property="og:image" content="/images/icon_hucd6a3d413e7b81060a1d462b35f64cf9_5018_512x512_fill_lanczos_center_2.png"><meta property="og:locale" content="pt-br"><meta property="article:published_time" content="2022-04-11T00:00:00+00:00"><meta property="article:modified_time" content="2022-04-11T00:00:00+00:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"/pt-br/post/python_ast_metaprogramming_with_introspection_and_decorators/"},"headline":"Metaprogram√ß√£o em Python com ASTs: criando um decorador com introspec√ß√£o [Draft]","datePublished":"2022-04-11T00:00:00Z","dateModified":"2022-04-11T00:00:00Z","author":{"@type":"Person","name":"Bruno Messias"},"publisher":{"@type":"Organization","name":"Bruno Messias","logo":{"@type":"ImageObject","url":"/images/icon_hucd6a3d413e7b81060a1d462b35f64cf9_5018_192x192_fill_lanczos_center_2.png"}},"description":" Python √© interpretado ou compilado? Conhecer as sutilezas da resposta para essa pergunta nos ajudar√° a entender e escrever um c√≥digo que escreve fun√ß√µes em tempo de execu√ß√£o (runtime) . Nosso exemplo ser√° um decorador que tem acesso ao locals de uma fun√ß√£o decorada sem usar truques com trace."}</script><title>Metaprogram√ß√£o em Python com ASTs: criando um decorador com introspec√ß√£o [Draft] | Bruno Messias</title></head><body id=top class=page-wrapper data-spy=scroll data-offset=70 data-target=#TableOfContents><aside class=search-results id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Pesquisar</h1></div><div class="col-6 col-search-close"><a class=js-search href=#><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Pesquisar... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><div class=page-header><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/pt-br>Bruno Messias</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar aria-expanded=false aria-label="Alterar navega√ß√£o">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/pt-br>Bruno Messias</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/pt-br/#about><span>About</span></a></li><li class=nav-item><a class=nav-link href=/pt-br/#posts><span>Recent Posts</span></a></li><li class=nav-item><a class=nav-link href=/pt-br/#projects><span>Projects</span></a></li><li class=nav-item><a class=nav-link href=/pt-br/#featured><span>Publications</span></a></li><li class=nav-item><a class="nav-link active" href=/pt-br/post/><span>Posts</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=Pesquisar><i class="fas fa-search" aria-hidden=true></i></a></li><li class="nav-item dropdown i18n-dropdown"><a href=# class="nav-link dropdown-toggle" data-toggle=dropdown aria-haspopup=true><i class="fas fa-globe mr-1" aria-hidden=true></i><span class="d-none d-lg-inline">Portugu√™s (Brasil)</span></a><div class=dropdown-menu><div class="dropdown-item dropdown-item-active"><span>Portugu√™s (Brasil)</span></div><a class=dropdown-item href=/post/python_ast_metaprogramming_with_introspection_and_decorators/><span>English</span></a></div></li></ul></div></nav></div><div id=macaquinho123 class=page-body><div class="container-fluid docs"><div class="row flex-xl-nowrap"><div class="col-12 col-md-10 offset-md-2"><div class=bg-overlay-img style="--bg-url: url(/pt-br/post/python_ast_metaprogramming_with_introspection_and_decorators/ast_english_sentence_hue5b8d52ce962721ee6d0acb19268cb10_239788_0x200_resize_lanczos_2.png)"><h1 class=text-left>Metaprogram√ß√£o em Python com ASTs: criando um decorador com introspec√ß√£o [Draft]</h1><p class="page-subtitle text-left">Python √© interpretado ou compilado? Conhecer as sutilezas da resposta para essa pergunta nos ajudar√° a entender e escrever um c√≥digo que escreve fun√ß√µes em tempo de execu√ß√£o (runtime)</p><div class=article-metadata><span class=article-date>Apr 11, 2022</span>
<span class=middot-divider></span><a href=/pt-br/post/python_ast_metaprogramming_with_introspection_and_decorators/#disqus_thread></a><span class=middot-divider></span><span class=article-categories><i class="fas fa-folder mr-1"></i><a href=/pt-br/category/python/>Python</a></span></div></div></div></div><div class="row flex-xl-nowrap"><div class="d-none d-md-block col-md-3 docs-toc sidebar-toc"><ul class="nav toc-top"><li><a href=# id=back_to_top class=docs-toc-title>Sum√°rio</a></li></ul><nav id=TableOfContents><ul><li><ul><li><a href=#introdu√ß√£o>Introdu√ß√£o</a></li><li><a href=#asts-o-que-s√£o>ASTs: O que s√£o?</a></li><li><a href=#python--interpretado-ou-compilado>Python: interpretado ou compilado?</a></li><li><a href=#extraindo-e-interpretando-asts>Extraindo e interpretando ASTs</a></li><li><a href=#como-meta-programar-de-forma-eficiente>Como meta-programar de forma eficiente?</a><ul><li><a href=#6-passos-simples>6 passos simples</a></li></ul></li><li><a href=#criando-nossa-meta-fun√ß√£o>Criando nossa meta-fun√ß√£o</a><ul><li><a href=#primeira-itera√ß√£o>Primeira itera√ß√£o</a></li><li><a href=#o-nodetransformer>O NodeTransformer</a></li><li><a href=#a-segunda-itera√ß√£o>A segunda itera√ß√£o</a></li><li><a href=#criando-uma-nova-fun√ß√£o-em-runtime>Criando uma nova fun√ß√£o em runtime</a></li></ul></li><li><a href=#integrando-a-manipula√ß√£o-de-ast-com-um-decorador>Integrando a manipula√ß√£o de AST com um decorador</a></li></ul></li></ul></nav></div><main class="col-12 col-md-9 py-md-3 pl-md-5 docs-content" role=main><article class=article><div class=article-container><div class=article-style><details class="toc-inpage d-print-none d-none d-sm-block d-md-none" open><summary class=font-weight-bold>Lista de Conte√∫dos</summary><nav id=TableOfContents><ul><li><ul><li><a href=#introdu√ß√£o>Introdu√ß√£o</a></li><li><a href=#asts-o-que-s√£o>ASTs: O que s√£o?</a></li><li><a href=#python--interpretado-ou-compilado>Python: interpretado ou compilado?</a></li><li><a href=#extraindo-e-interpretando-asts>Extraindo e interpretando ASTs</a></li><li><a href=#como-meta-programar-de-forma-eficiente>Como meta-programar de forma eficiente?</a><ul><li><a href=#6-passos-simples>6 passos simples</a></li></ul></li><li><a href=#criando-nossa-meta-fun√ß√£o>Criando nossa meta-fun√ß√£o</a><ul><li><a href=#primeira-itera√ß√£o>Primeira itera√ß√£o</a></li><li><a href=#o-nodetransformer>O NodeTransformer</a></li><li><a href=#a-segunda-itera√ß√£o>A segunda itera√ß√£o</a></li><li><a href=#criando-uma-nova-fun√ß√£o-em-runtime>Criando uma nova fun√ß√£o em runtime</a></li></ul></li><li><a href=#integrando-a-manipula√ß√£o-de-ast-com-um-decorador>Integrando a manipula√ß√£o de AST com um decorador</a></li></ul></li></ul></nav></details><h2 id=introdu√ß√£o>Introdu√ß√£o</h2><p>N√£o se assuste com as palavras no t√≠tulo. Embora elas podem ser estranhas para voc√™ provavelmente em algum momento voc√™ utilizou ferramentas que fazem uso de t√©cnicas de metaprograma√ß√£o ou inspe√ß√£o de AST. Pytest e Numba s√£o exemplos.</p><p>No post anterior eu falei sobre python frames e inspection. Mostrei como podemos usar <code>inspect.signautre</code> para criar um decorador que valide argumentos:</p><pre><code class=language-python>
@math_validator() 

def simple_method(x: &quot;\in R&quot;, y: &quot;\in R_+&quot;, z: float = 2) -&gt; float: 

    ... 

simple_method(1, 0) 

</code></pre><pre><code>
simple_method((1, 2)) -&gt; 1.5 

---&gt; 19 simple_method(1, 0) 

... 

&lt;locals&gt;.decorate.&lt;locals&gt;.decorated(*_args) 

     11         continue 

     13     if not MATH_SPACES[annotation][&quot;validator&quot;](_args[i]): 

---&gt; 14         raise ValueError(f&quot;{k} doesn't belong to the {MATH_SPACES[annotation]['name']}&quot;) 

     15 result = func(*_args) 

     16 print(f&quot;{func.__name__}({_args}) -&gt; {result}&quot;) 

  

ValueError: y doesn't belong to the space of real numbers greater than zero 

</code></pre><p>O outro mostrei como podemos combinar o <code>signature</code> com <code>sys.trace</code> para criar um decorador que exp√µe o <code>locals</code> da fun√ß√£o decorada. O que nos permite fazer coisas legais tais como criar um um decorador <code>@report</code></p><pre><code class=language-python>
@report('{arg.n_bananas} Monkey {gluttonous_monkey} ate too much bananas.  Num monkeys {num_monkeys}') 

def feed_monkeys(n_bananas):  

    num_monkeys = 3 

    monkeys = { 

        f&quot;monkey_{i}&quot;: {&quot;bananas&quot;: 0} 

        for i in range(num_monkeys) 

    } 

    while n_bananas &gt; 0: 

        if np.random.uniform() &lt; 0.4: 

            continue 

        monkey = monkeys[np.random.choice(list(monkeys.keys()))] 

        if n_bananas &gt; 0: 

            monkey[&quot;bananas&quot;] += 1 

            n_bananas -= 1 

    gluttonous_monkey = max(monkeys, key=lambda k: monkeys[k][&quot;bananas&quot;])  

</code></pre><p>Contudo, no final do post pssado eu disse que essa solu√ß√£o tem alguns problemas</p><div class=spoiler><p><a class="btn btn-primary" data-toggle=collapse href=#spoiler-1 role=button aria-expanded=false aria-controls=spoiler-1>Click here to see the solution</a></p><div class="collapse card" id=spoiler-1><div class=card-body><pre><code class=language-python>
import sys 

import inspect 

from types import SimpleNamespace 

  

  

def call_and_extract_frame(func, *args, **kwargs): 

    frame_var = None 

    trace = sys.gettrace() 

    def update_frame_var(stack_frame, event_name, arg_frame): 

        &quot;&quot;&quot; 

        Args: 

            stack_frame: (frame) 

                The current stack frame. 

            event_name: (str) 

                The name of the event that triggered the call.  

                Can be 'call', 'line', 'return' and 'exception'. 

            arg_frame:  

                Depends on the event. Can be a None type 

        &quot;&quot;&quot; 

        nonlocal frame_var # nonlocal is a keyword which allows us to modify the outisde scope variable 

        if event_name != 'call': 

            return trace 

        frame_var = stack_frame 

        sys.settrace(trace) 

        return trace 

    sys.settrace(update_frame_var) 

    try: 

        func_result = func(*args, **kwargs) 

    finally: 

        sys.settrace(trace) 

    return frame_var, func_result 

def report(formater): 

    def decorate(func): 

        def decorated(*_args): 

            sig = inspect.signature(func) 

            named_args = {} 

            num_args = len(_args) 

            for i, (k, v) in enumerate(sig.parameters.items()): 

                if i &lt; num_args: 

                    named_args[k] = repr(_args[i]) 

                else: 

                    named_args[k] = repr(v.default) 

            frame_func, _result = call_and_extract_frame(func, *_args) 

            name = func.__name__ 

            result = repr(_result) 

             

            args_dict = { 

                &quot;args&quot;: SimpleNamespace(**named_args),  

                &quot;args_repr&quot;: repr(SimpleNamespace(**named_args)), 

                **locals(), 

                **frame_func.f_locals, 

            } 

            print(formater.format(**args_dict)) 

            # do other stuff here 

            return _result  

        return decorated 

    return decorate 

</code></pre></div></div></div><p>Quais s√£o esses problemas?</p><ul><li><p>√â esperado que o tracing reduza a performance do sistema. Se voc√™ usar a solu√ß√£o acima s√≥ para casos pontuais ou debug √© ok</p></li><li><p>Pode criar conflitos com outras ferramentas e bibliotecas que tamb√©m est√£o usando a ferramenta de tracing, tais como debuggers.</p></li><li><p>Parece uma solu√ß√£o feia!</p></li></ul><p>Voc√™ pode se perguntar: &ldquo;Overenginerieng! Pq esse cara n√£o faz simplesmente isto aqui?</p><pre><code class=language-python>
@report('stuff goes here') 

def func(x, y): 

    random_var = np.random.uniform() 

    ... #more local vars 

    result = (x+y)**random_var 

    return result, locals  

</code></pre><p><em>&rdquo;..e dentro do decorador ele muda para isso"</em></p><pre><code class=language-python>
_result, local_vars = func(x, y) 

</code></pre><p>A raz√£o √©:</p><p>O ponto de usar um decorador √© para evitar ter que fazer mudan√ßas em qualquer outra parte da nossa codebase. Por exemplo, se em qualquer outra parte da nossa codebase <code>func</code> est√° sendo chamada, eu teria que fazer mudan√ßas do tipo</p><pre><code class=language-python>
result = func(x, y) # to  

result = func(x, y)[0] 

</code></pre><p>E se futuramente e quisesse remover o decorador de report de uma fun√ß√£o eu teria que desfazer todas as mudan√ßas acima</p><ul><li><p>Voc√™ ira aumentar o cognitive load de todos os membros do seu time que n√£o precisam saber sobre ou usar o decorador.</p></li><li><p>Se voc√™ est√° ok com fazer mudan√ßas em outros lugares do seu c√≥digo pq n√£o simplesmente criar novas fun√ß√µes ao inv√©s decoradores que funcionam mais ou menos?</p></li></ul><p>Ok, voc√™ pode estar pensando: &ldquo;T√° , faz sentido n√£o fazer isso que sugeri, mas do que adianta evitar sujar sua codebase se voc√™ t√° criando problemas de desempenho e debugg? N√£o parece uma boa solu√ß√£o na maioria dos casos. Eu tenho que concordar com voc√™!&rdquo;</p><p>Bom, ent√£o o que podemos fazer?? O problema que encontramos √© que em python n√£o temos context managers que podem lidar com namespaces
<a href=https://mail.python.org/archives/list/python-ideas@python.org/thread/TAVHEKDZVYKJUGZKWSVZVAOGBPLZVKQG/ target=_blank rel=noopener>https://mail.python.org/archives/list/python-ideas@python.org/</a>. Mas se desanime com essa limita√ß√£o, a quest√£o agora √©:</p><div class="alert alert-note"><div><strong>Se uma linguagem n√£o tem uma feature que eu preciso o que eu posso fazer?</strong></div></div><p>Em pyhton estamos bem com isso pois √© f√°cil manipular o que √© conhecido como <strong>A</strong>bstract <strong>S</strong>yntax <strong>T</strong>ree (√°rvores sint√°tica abstrata) e compilar ela em uma nova fun√ß√£o em tempo de execu√ß√£o (runtime). ** Quando programamos desse jeito estamos no reino da meta-programa√ß√£o! Tentarei esclarecer esses pontos agora**</p><h2 id=asts-o-que-s√£o>ASTs: O que s√£o?</h2><p>Uma linguagem de programa√ß√£o √© obviamente, pelo menos uma linguagem&mldr; OK, <strong>mas o que √© uma linguagem? Todas as linguagens humanas compartilham uma estrutura em comum? Como podemos comparar senten√ßas diferentes na mesma linguagem?</strong> Essas quest√µes talvez pare√ßam ser mais adequadas para serem respondidas por fil√≥sofos. Contudo, tamb√©m √© tema de trabalho de matem√°ticos e computeiros</p><p>A grande diferen√ßa √© que matem√°ticos e computeiros comumente preferem falar sobre coisas usando algum formalismo matem√°tico. Em ess√™ncia, <strong>AST</strong> faz parte de um formalismo matem√°tico que permite isso. Uma <strong>AST</strong> permite representar uma senten√ßa atrav√©s de um grafo direcionado do tipo √°rvore. Para isso usamos um conjunto de regras bem definidas em como construir essa √°rvore.</p><h3>Como saber se uma senten√ßa est√° gramaticalmente correta?</h3><p>Voc√™ provavelmente se lembra quase institivamente de um conjunto de regras que aprendeu durante sua vida ou acabou se acostumando sobre como organizar e compor verbos, substantivos, adjetivos, etc. Este conjunto de regras e guias √© a sintaxe da linguagem que voc√™ fala/escreve. <em>AST</em>s permitem checar e compreender uma senten√ßa utilizando essas regras</p><p>Pegue por exemplo a senten√ßa</p><p><em>&ldquo;I drive a car to my college&rdquo;</em>, a AST √© a seguinte</p><figure id=figure-a-syntax-tree-for-the-sentence-i-drive-a-car-to-my-college-source-geeks-for-geekssyntax-tree--natural-language-processinghttpswwwgeeksforgeeksorgsyntax-tree-natural-language-processing><a data-fancybox href=/pt-br/post/python_ast_metaprogramming_with_introspection_and_decorators/ast_english_sentence_hue5b8d52ce962721ee6d0acb19268cb10_239788_0x400_resize_lanczos_2.png data-caption='A <strong>S</strong>yntax <strong>T</strong>ree for the sentence: <em>I drive a car to my college</em>. <strong>Source</strong>:<a href="https://www.geeksforgeeks.org/syntax-tree-natural-language-processing/"> Geeks for Geeks:Syntax Tree ‚Äì Natural Language Processing.</a>'><img src=/pt-br/post/python_ast_metaprogramming_with_introspection_and_decorators/ast_english_sentence_hue5b8d52ce962721ee6d0acb19268cb10_239788_0x400_resize_lanczos_2.png alt height=400px></a><figcaption>A <strong>S</strong>yntax <strong>T</strong>ree for the sentence: <em>I drive a car to my college</em>. <strong>Source</strong>:<a href=https://www.geeksforgeeks.org/syntax-tree-natural-language-processing/> Geeks for Geeks:Syntax Tree ‚Äì Natural Language Processing.</a></figcaption></figure><p>Qual a vantagem de usar ASTs? Note que n√£o precisamos falar de espa√ßos, caligrafia ou estilo pessoal de organizar escrita para compreender uma senten√ßa e saber se ela est√° v√°lida. Al√©m disso, temos uma estrutura hier√°rquica que permite entender a senten√ßa por n√≠veis!</p><p>N√£o √© uma surpresa que ASTs s√£o tamb√©m uma ferramenta comum em processos de analisar a validade de um c√≥digo ou na constru√ß√£o de um compilador/interpretador. Nesse post iremos manipular a AST! Mas antes disso quero fazer uma pergunta:</p><h5 class=text-center>Python √© uma linguagem interpretada?</h5><h2 id=python--interpretado-ou-compilado>Python: interpretado ou compilado?</h2><p>Geralmente, quando encontro um hater de python ou mesmo um entusiasta eu ou√ßo ou leio coisas do tipo:</p><ul><li><p>&ldquo;<em>Python √© lento pois √© uma linguagem interpretada</em>&rdquo;</p></li><li><p>&ldquo;*Python √© legal pois n√£o tem chatice de compila√ß√£o&rdquo;</p></li><li><p><em>&ldquo;Python √© ruim comparado a C pois n√£o tem um compilador&rdquo;</em></p></li></ul><p>Bem, essas aser√ß√µes n√£o s√£o verdadeiras, pois est√£o usando conceitos errados! Outra confus√£o √©
que geralmente quando se fala em python estamos nos referindo a linguagem (sintaxe) do python mais a maquina virtual do CPython. Vamos conversar um pouco mais sobre isso</p><p>Dizer que uma linguagem hoje √© <em>puramente</em> compilada ou interpretada √© meio confuso, pois atualmente essa divis√£o √© borrada. Veja o seguinte</p><pre><code class=language-python>hello_world = &quot;print('Hello, world!')&quot;
hello_world_obj = compile(hello_world, '&lt;string&gt;', 'single')
</code></pre><p>Pois √©, se voc√™ ia tentar defender nos coment√°rios que python √© puramente interpretado as coisas est√£o mais dif√≠ceis para voc√™. Por que tem um <code>compile</code> dispon√≠vel? O que ele faz?</p><pre><code class=language-python>exec(hello_world_obj)
Hello, world!
</code></pre><p>O que ser√° que tem dentro desse <code>hello_world_obj</code>?</p><pre><code class=language-python>print(f&quot;Bad news for you:\n\tContent: {hello_world_obj.co_code}\n\tType: {type(hello_world_obj.co_code)}&quot;)
</code></pre><pre><code>Bad news for you:
	Content: b'e\x00d\x00\x83\x01F\x00d\x01S\x00'
	Type: &lt;class 'bytes'&gt;
</code></pre><p>Para entender, mesmo que superficialmente, os prints acima voc√™ precisa compreender o que acontece por tr√°s dos panos quando um c√≥digo python √© &ldquo;interpretado&rdquo;</p><p>Ap√≥s voc√™ escrever um c√≥digo e chamar o comando python, o python inicia um processo de compila√ß√£o criando as ASTs, depois gerando bytecodes a partir das ASTs e esses √∫ltimos ser√£o encapsulados em <code>code_object</code>s. E na √∫ltima etapa os code objects ser√£o interpretados pela m√°quina virtual do CPython. O diagrama √† baixo √© uma representa√ß√£o simples (com passos omitidos) do processo</p><div class="mermaid mermaidContainer">graph LR;
A[Source Code]-->|parsing|B[Parse Tree];
B-->C[AST];
C-->E[Bytecode];
E-->F[Code Object];
F-->|execution by|G[CPython Virtual Machine];</div><p>A fase de compila√ß√£o s√£o os primeiros passos do diagrama acima</p><div class="mermaid mermaidContainer">graph LR;
A[Source Code]-->|parsing|B[Parse Tree];
B-->C[AST];
C-->E[Bytecode];
E-->F[Code Object];</div>Se voc√™ n√£o conhece os conceitos dos nomes acima n√£o se preocupe, n√£o precisamos de tanto aprofundamento.
**Bytecodes s√£o apenas uma maneira compacta de dizer ao interpretador o que o c√≥digo quer que ele fa√ßa. Enquanto code objects s√£o coisas que encapsulam esses bytecodes.**<p>Ok, onde isso entra na minha solu√ß√£o? O que preciso fazer √© manipular a AST e compilar um novo code object que ser√° interpretado pelo cpython!</p><blockquote><p>Um hist√≥ria engra√ßada do Luciano Ramalho:<blockquote class=twitter-tweet><p lang=en dir=ltr>In 2018 I told a CBP officer I was entering the US to speak at PyCon. He asked: "Is Python interpreted or compiled?" After a 2 second pause I said "Interpreted". I didn't give the correct answer because I didn't want to extend the "pleasant" conversation. He let me in.</p>&mdash; Luciano Ramalho ‚òî üêç ‚öó ‚ñ∂Ô∏èüò∑üíâüíâüíâ (@ramalhoorg) <a href="https://twitter.com/ramalhoorg/status/1474044907585167362?ref_src=twsrc%5Etfw">December 23, 2021</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script></p></blockquote><h2 id=extraindo-e-interpretando-asts>Extraindo e interpretando ASTs</h2><p>Veja o seguinte exemplo:</p><pre><code class=language-python>import inspect
import ast
import astor # install this for pretty printing
def example(a: float, b:float = 2) -&gt; float:
    s = a+b
    return s

tree = ast.parse(inspect.getsource(example))
print(astor.dump(tree))
astor.to_source(tree)
</code></pre><pre><code>Module(
    body=[
        FunctionDef(name='example',
            args=arguments(posonlyargs=[],
                args=[arg(arg='a', annotation=Name(id='float'), type_comment=None),
                    arg(arg='b', annotation=Name(id='float'), type_comment=None)],
                vararg=None,
                kwonlyargs=[],
                kw_defaults=[],
                kwarg=None,
                defaults=[Constant(value=2, kind=None)]),
            body=[
                Assign(targets=[Name(id='s')],
                    value=BinOp(left=Name(id='a'), op=Add, right=Name(id='b')),
                    type_comment=None),
                Return(value=Name(id='s'))],
            decorator_list=[],
            returns=Name(id='float'),
            type_comment=None)],
    type_ignores=[])
</code></pre><p>O output acima √© a AST da fun√ß√£o. Gaste algum tempo olhando essa sa√≠da e tente entender/inferir o que cada coisa signfica e como ela √© organizada. A imagem abaixo √© a representa√ß√£o visual da sa√≠da acima</p><figure><a data-fancybox href=/pt-br/post/python_ast_metaprogramming_with_introspection_and_decorators/simple_ast_hudca446749283cbe6d28b67a245474890_120568_0x1000_resize_lanczos_2.png><img src=/pt-br/post/python_ast_metaprogramming_with_introspection_and_decorators/simple_ast_hudca446749283cbe6d28b67a245474890_120568_0x1000_resize_lanczos_2.png alt height=400px></a></figure><p>Cada elemento do output que inicia com uma letra mai√∫scula √© um n√≥, <strong>node</strong>(Name, BinOp, FunctionDef, etc) derivado da classe <code>ast.Node</code>. Um dos n√≥s mais importante √© o <code>ast.Name</code>.
Por exemplo em</p><pre><code>value=BinOp(left=Name(id='a'), op=Add, right=Name(id='b')),
</code></pre><p>o <code>ast.Name(...</code> √© usado para referenciar as vari√°veis <code>a</code> e <code>b</code> da nossa fun√ß√£o.</p><p>Ok, voltemos ao nosso problema. Lembre que uma solu√ß√£o ruim era reescrever cada fun√ß√£o que precisa ser decorada, por exemplo</p><pre><code class=language-python>def func(x, y):
    random_var = np.random.uniform()
    ... #more local vars
    result = (x+y)**random_var
    return result
</code></pre><p>como</p><pre><code class=language-python>def func_transformed(x, y):
    random_var = np.random.uniform()
    ... #more local vars
    result = (x+y)**random_var
    return result, locals 
</code></pre><p>A coisa legal que faremos aqui √© <strong>escrever uma fun√ß√£o que escrevera essas mudan√ßas para n√≥s! E depois colocaremos a compila√ß√£o dentro de um decorador para evitar que nossa codebase seja alterada.</strong></p><h2 id=como-meta-programar-de-forma-eficiente>Como meta-programar de forma eficiente?</h2><p>Fazer um c√≥digo que fa√ßa as altera√ß√µes desejadas na nossa AST pode ser trabalhoso. Como come√ßar a ter uma ideia do que precisa ser feito? Eu penso em uma sucess√£o de 6 passos e ir iterando para melhorar</p><h3 id=6-passos-simples>6 passos simples</h3><ol><li>Criar uma fun√ß√£o exemplo (A)</li><li>Codar uma fun√ß√£o transformada do jeito que queremos que ela seja (B)</li><li>Escrever um teste para que possa ser usado posteriormete para<br>checar se nossa fun√ß√£o transformada (B) bate com a fun√ß√£o gerada pela meta-programa√ß√£o (C)</li><li>Extrair a AST de A e B</li><li>Comparar as ASTs. O que elas diferem? Anote as diferen√ßas<ul><li>Voc√™ pode usar a <code>difflib</code> do python para fazer isso</li></ul></li><li>Criar uma nova e mais complexa fun√ß√£o exemplo (A) e repetir o processo at√© termos uma boa ideia das modifica√ß√µes necess√°rias na AST</li></ol><h2 id=criando-nossa-meta-fun√ß√£o>Criando nossa meta-fun√ß√£o</h2><h3 id=primeira-itera√ß√£o>Primeira itera√ß√£o</h3><p>Vamos come√ßar escrevendo uma fun√ß√£o incrivelmente simples</p><pre><code class=language-python>def example_1(x, y):
    internal_var  =  222
    result = (x+y)**internal_var
    return result
def example_1_expected(x, y):
    internal_var = 222
    result = (x+y)**internal_var
    return result, locals()

def test_meta_example_1(meta_func, x, y):
    expected_result, expected_locals = example_1_expected(x, y)
    result, locals_dict = meta_func(x, y)
    assert result == expected_result
    assert expected_locals == locals_dict
</code></pre><p>Agora, vou usar o <code>difflib</code> para entender as diferen√ßas entre as duas ASTs.</p><pre><code class=language-python>import difflib
from pprint import pprint

example_1_ast_str = astor.dump_tree(ast.parse(inspect.getsource(example_1)))
example_1_expected_str = astor.dump_tree(ast.parse(inspect.getsource(example_1_expected)))


pprint(
    list(
        difflib.unified_diff(example_1_ast_str.splitlines(), example_1_expected_str.splitlines(), n=0)
    )
)
</code></pre><pre><code>
    ['--- \n',
     '+++ \n',
     '@@ -3 +3 @@\n',
     &quot;-        FunctionDef(name='example_1',&quot;,
     &quot;+        FunctionDef(name='example_1_expected',&quot;,
     '@@ -19 +19 @@\n',
     &quot;-                Return(value=Name(id='result'))],&quot;,
     &quot;+                Return(value=Tuple(elts=[Name(id='result'), &quot;
     &quot;Call(func=Name(id='locals'), args=[], keywords=[])]))],&quot;]
</code></pre><p>Sabemos ent√£o que precisamos mudar o seguinte Node na AST</p><pre><code>Return(value=Name(id='result'))],
</code></pre><p>para isto</p><pre><code>Return(value=Tuple(elts=[Name(id='result'), Call(func=Name(id='locals'), args=[], keywords=[])]))],
</code></pre><p>Como aletramos Nodes na AST? Com a ajuda do <code>NodeTransformer</code></p><h3 id=o-nodetransformer>O NodeTransformer</h3><p>O <code>ast.NodeTransformer</code> nos permite criar objetos com uma interface de caminhante. O caminhante visitar√° cada Node da AST e durante cada visita ele pode remover, substituir, modificar ou adicionar Nodes. Ap√≥s fazer essas altera√ß√µes o caminhante pode continuar sua caminhada nos filhos do Node ou apenas parar.</p><p>Vamos iniciar criando uma classe derivada de <code>ast.NodeTransformer</code></p><pre><code class=language-python>class ASTTransformer(ast.NodeTransformer):
    def visit_Return(self, node):
</code></pre><p>Se queremos interagir com um Node type <code>AlgumaCoisa</code> precisamos dar override no m√©todo <code>visit_AlgumaCoisa</code>.
Portanto, como sabemos que precisamos mudar o <code>Return</code> iremos sobrescrever o <code>visit_Return</code>. Nos precisamos tamb√©m criar um n√≥ para pegar o <code>locals</code>. Esse n√≥ √© um Node to tipo <code>Call</code></p><pre><code class=language-python>class ASTTransformer(ast.NodeTransformer):
    def visit_Return(self, node):
        node_locals = ast.Call(
            func=ast.Name(id='locals', ctx=ast.Load()),
            args=[], keywords=[]
        )
        self.generic_visit(node)
        return node
</code></pre><p>Veja que usamos o n√≥ <code>Name</code> para identificar a fun√ß√£o <code>locals</code>. Agora, de acordo com o resultado do nosso diff o resultado do <code>Return</code> precisa ser uma Node do tipo <code>Tuple</code></p><pre><code class=language-python>class ASTTransformer(ast.NodeTransformer):
    def visit_Return(self, node):
        node_locals = ast.Call(
            func=ast.Name(id='locals', ctx=ast.Load()),
            args=[], keywords=[]
        )
        new_node.value = ast.Tuple(
            elts=[
                node.value,
                node_locals
            ],
            ctx=ast.Load()
        )
        self.generic_visit(new_node)
        return new_node
</code></pre><p>Uma nova coisa apareceu. O argumento <code>elts</code>. N√£o se preoucupe em entender tudo. Mas o <code>elts</code> √© um arg que diz qual √© a lista de Nodes que a Tupla deve conter. Toda vez que voc√™ quiser entender um pouco mais sobre ASTs e a gram√°tica abstrata do python voc√™ pode consultar a documenta√ß√£o oficial
<a href=https://docs.python.org/3/library/ast.html target=_blank rel=noopener>aqui</a>.</p><p>Quase tudo pronto. A √∫ltima coisa que precisamos fazer √© corrigir nossa AST. Pois ao alterar o Node precisamos preencher/corrigir as informa√ß√µes de line_number e column_offest. O python torna isso f√°cil com o m√©todo <code>fix_missing_locations</code></p><pre><code class=language-python>
class ASTTransformer(ast.NodeTransformer):
    def visit_Return(self, node):
        new_node = node
        node_locals = ast.Call(
            func=ast.Name(id='locals', ctx=ast.Load()),
            args=[], keywords=[]
        )
        new_node.value = ast.Tuple(
            elts=[
                node.value,
                node_locals
            ],
            ctx=ast.Load()
        )
        ast.copy_location(new_node, node)
        ast.fix_missing_locations(new_node)
        self.generic_visit(new_node)
        return new_node
</code></pre><p>Vamos ver se t√° funcionando. Precisamos instanciar nosso transformer e chamar o m√©todo <code>visit</code> que diz para o caminhante iniciar a caminhada e fazer as modifica√ß√µes que estamos pedindo.</p><pre><code class=language-python>tree_meta = ast.parse(inspect.getsource(example_1))
transformer = ASTTransformer()
transformer.visit(tree_meta)
example_1_meta_ast_str = astor.dump_tree(tree_meta)
example_1_expected_str = astor.dump_tree(ast.parse(inspect.getsource(example_1_expected)))


pprint(
    list(
        difflib.unified_diff(example_1_meta_ast_str.splitlines(), example_1_expected_str.splitlines(), n=0)
    )
)
</code></pre><pre><code>
    ['--- \n',
     '+++ \n',
     '@@ -3 +3 @@\n',
     &quot;-        FunctionDef(name='example_1',&quot;,
     &quot;+        FunctionDef(name='example_1_expected',&quot;]

</code></pre><p>Funcionou! Vamos adicionar um pouco mais de complica√ß√£o para ver o transformer continuar√° funcionando.</p><h3 id=a-segunda-itera√ß√£o>A segunda itera√ß√£o</h3><p>Seja criativo na hora de complicar, eu fiz isso aqui, feio, mais adiciona muita confus√£o para o transformer</p><pre><code class=language-python>def example_2(x, y):
    internal_var  =  222
    def sub(x, y):
        ommit_this_var = 1
        return x - y
    result = sub(x,y)**internal_var
    return (result, False)
def example_2_expected(x, y):
    internal_var  =  222
    def sub(x, y):
        ommit_this_var = 1
        return x - y
    result = sub(x,y)**internal_var
    return ((result, False), locals())
def test_meta_example_2(meta_func, x, y):
    expected_result, expected_locals = example_2_expected(x, y)
    result, locals_dict = meta_func(x, y)
    del locals_dict[&quot;sub&quot;]
    del expected_locals[&quot;sub&quot;]
    assert result == expected_result
    assert expected_locals == locals_dict
</code></pre><pre><code class=language-python>example_2_ast_str = astor.dump_tree(ast.parse(inspect.getsource(example_2)))
example_2_expected_str = astor.dump_tree(ast.parse(inspect.getsource(example_2_expected)))


pprint(
    list(
        difflib.unified_diff(example_2_ast_str.splitlines(), example_2_expected_str.splitlines(), n=0)
    )
)
</code></pre><pre><code>    ['--- \n',
     '+++ \n',
     '@@ -3 +3 @@\n',
     &quot;-        FunctionDef(name='example_2',&quot;,
     &quot;+        FunctionDef(name='example_2_expected',&quot;,
     '@@ -37 +37,4 @@\n',
     &quot;-                Return(value=Tuple(elts=[Name(id='result'), &quot;
     'Constant(value=False, kind=None)]))],',
     '+                Return(',
     '+                    value=Tuple(',
     &quot;+                        elts=[Tuple(elts=[Name(id='result'), &quot;
     'Constant(value=False, kind=None)]),',
     &quot;+                            Call(func=Name(id='locals'), args=[], &quot;
     'keywords=[])]))],']
</code></pre><p>Agora √© hora de cruzar os dedos e esperar que continue funcionando</p><pre><code class=language-python>tree_meta = ast.parse(inspect.getsource(example_2))
transformer = ASTTransformer()
transformer.visit(tree_meta)
example_2_meta_ast_str = astor.dump_tree(tree_meta)
example_2_expected_str = astor.dump_tree(ast.parse(inspect.getsource(example_2_expected)))


pprint(
    list(
        difflib.unified_diff(example_2_meta_ast_str.splitlines(), example_2_expected_str.splitlines(), n=0)
    )
)
</code></pre><pre><code>    ['--- \n',
     '+++ \n',
     '@@ -3 +3 @@\n',
     &quot;-        FunctionDef(name='example_2',&quot;,
     &quot;+        FunctionDef(name='example_2_expected',&quot;,
     '@@ -27,4 +27 @@\n',
     '-                        Return(',
     '-                            value=Tuple(',
     &quot;-                                elts=[BinOp(left=Name(id='x'), op=Sub, &quot;
     &quot;right=Name(id='y')),&quot;,
     &quot;-                                    Call(func=Name(id='locals'), args=[], &quot;
     'keywords=[])]))],',
     &quot;+                        Return(value=BinOp(left=Name(id='x'), op=Sub, &quot;
     &quot;right=Name(id='y')))],&quot;]
</code></pre><p>Falhou miseravelmente. Qual √© o problema? Se voc√™ olhar o diff com cuidado verar que o transformer alterou a fun√ß√£o interna. N√£o queremos isso. Portanto diremos para o caminhante evitar modificar se estiver em uma fun√ß√£o interna. Para isso, precisamos sobrescrever o m√©todo <code>visit_FunctionDef</code> e criar uma flag para marcar em que n√≠vel o caminhante est√°</p><pre><code class=language-python>class ASTTransformer(ast.NodeTransformer):
    def visit_FunctionDef(self, node):
        if self._sub:
            return node
        self._sub = True
        self.generic_visit(node)
        return node

    def visit_Module(self, node):
        self._sub = 0
        self.generic_visit(node)

    def visit_Return(self, node):
        new_node = node
        node_locals = ast.Call(
            func=ast.Name(id='locals', ctx=ast.Load()),
            args=[], keywords=[]
        )
        new_node.value = ast.Tuple(
            elts=[
                node.value,
                node_locals
            ],
            ctx=ast.Load()
        )
        ast.copy_location(new_node, node)
        ast.fix_missing_locations(new_node)
        self.generic_visit(new_node)
        return new_node 
</code></pre><pre><code class=language-python>tree_meta = ast.parse(inspect.getsource(example_2))
transformer = ASTTransformer()
transformer.visit(tree_meta)
example_2_meta_ast_str = astor.dump_tree(tree_meta)
example_2_expected_str = astor.dump_tree(ast.parse(inspect.getsource(example_2_expected)))


pprint(
    list(
        difflib.unified_diff(example_2_meta_ast_str.splitlines(), example_2_expected_str.splitlines(), n=0)
    )
)
</code></pre><pre><code>    ['--- \n',
     '+++ \n',
     '@@ -3 +3 @@\n',
     &quot;-        FunctionDef(name='example_2',&quot;,
     &quot;+        FunctionDef(name='example_2_expected',&quot;]
</code></pre><p>Tudo ok! Pr√≥ximo passo</p><h3 id=criando-uma-nova-fun√ß√£o-em-runtime>Criando uma nova fun√ß√£o em runtime</h3><p>O que faremos agora √© compilar a AST transforamada e associa-la com uma nova fun√ß√£o. Em python podemos fazer isso em tempo de execu√ß√£o com <code>type.FunctionType</code></p><pre><code class=language-python>from types import FunctionType, CodeType

def transform_and_compile(func: FunctionType)-&gt;FunctionType:
    source = inspect.getsource(func)
    # we put this to remove the line from source code with the decorator
    source = &quot;\n&quot;.join([l for l in source.splitlines() if not l.startswith(&quot;@&quot;)])
    tree = ast.parse(source)
    transformer = ASTTransformer()
    transformer.visit(tree)
    code_obj = compile(tree, func.__code__.co_filename, 'exec')
    function_code = [c for c in code_obj.co_consts if isinstance(c, CodeType)][0]
    # we must to pass the globals context to the function
    transformed_func = FunctionType(function_code, func.__globals__)
    return transformed_func
</code></pre><pre><code class=language-python>test_meta_example_1(transform_and_compile(example_1), 4, 2)
test_meta_example_2(transform_and_compile(example_2), 1, 2)

</code></pre><p>Veja que <code>transform_and_compile</code> foi capaz de criar novas fun√ß√µes que passaram nos testes que escrevemos nas itera√ß√µes anteriores! Agora √© o passo final e mais f√°cil desse post. Integrar com o decorador.</p><h2 id=integrando-a-manipula√ß√£o-de-ast-com-um-decorador>Integrando a manipula√ß√£o de AST com um decorador</h2><p>O que faremos √© chamar <code>transform_and_compile</code> logo ap√≥s o <code>def decorate</code> para evitar compila√ß√µes desnecess√°rias toda vez que chamarmos a fun√ß√£o decorada</p><pre><code class=language-python>def report(fmt):
    def decorate(func):
        meta_func = transform_and_compile(func)
        ....
</code></pre><p>Agora, dentro de <code>def decorated</code> podemos chamar a <code>meta_func</code> e retornar s√≥ o resultado pois n√£o queremos mudar nossa codebase</p><pre><code class=language-python>def report(fmt):
    def decorate(func):
        meta_func = transform_and_compile(func)
        ...
        def decorated(*_args):
            _result, internal_locals = meta_func(*_args)
            ....
            return _result
</code></pre><p>Com todas as coisas que fizemos no post nosso decorador <code>report</code> est√° pronto para ser usado</p><pre><code class=language-python>
def report(fmt):
    def decorate(func):
        meta_func = transform_and_compile(func)
        sig = inspect.signature(func)
        def decorated(*_args):
            _result, internal_locals = meta_func(*_args)
            named_args = {}
            num_args = len(_args)
            for i, (k, v) in enumerate(sig.parameters.items()):
                if i &lt; num_args:
                    named_args[k] = repr(_args[i])
                else:
                    named_args[k] = repr(v.default)
            
            name = func.__name__
            result = repr(_result)
            args_dict = {
                **internal_locals,
                **locals(),
                **named_args
            }
            print(fmt.format(**args_dict))
            # store the information in some place
            return result
        return decorated 
    return decorate
</code></pre><p>Vejamos o resultado em uma fun√ß√£o bem simples</p><pre><code class=language-python>@report(fmt='{name}(a={a}, b={b}, c={c}); sum_ab {sum_ab}, diff_ab {dif_ab}; r={result}')
def dummy_example(a, b, c=2):
    sum_ab = a + b
    dif_ab = a - b
    r = sum_ab**c + dif_ab**c
    return r

r = dummy_example(2, 3, 1)
print(&quot;r:&quot;, r)
</code></pre><pre><code>    dummy_example(a=2, b=3, c=1); sum_ab 5, diff_ab -1; r=4
    r: 4
</code></pre><p>Eu sei que esse post pode ter sido dif√≠cil, se tiver d√∫vida voc√™ pode entrar em contato comigo pelos coment√°rios abaixo, twitter ou linkedin. Compartilhe se voc√™ gostou.</p></div><div class=article-tags><a class="badge badge-light" href=/pt-br/tag/python/>python</a>
<a class="badge badge-light" href=/pt-br/tag/ast/>ast</a>
<a class="badge badge-light" href=/pt-br/tag/compilers/>compilers</a>
<a class="badge badge-light" href=/pt-br/tag/decorators/>decorators</a>
<a class="badge badge-light" href=/pt-br/tag/debugging/>debugging</a>
<a class="badge badge-light" href=/pt-br/tag/hacks/>hacks</a></div><div class=share-box aria-hidden=true><h5 class=text-center>Compartilhe se voc√™ gostou</h5><ul class=share><li><a href="https://twitter.com/intent/tweet?url=/pt-br/post/python_ast_metaprogramming_with_introspection_and_decorators/&text=Metaprogram%c3%a7%c3%a3o%20em%20Python%20com%20ASTs:%20criando%20um%20decorador%20com%20introspec%c3%a7%c3%a3o%20[Draft]" target=_blank rel=noopener class=share-btn-twitter><i class="fab fa-twitter"></i></a></li><li><a href="https://www.facebook.com/sharer.php?u=/pt-br/post/python_ast_metaprogramming_with_introspection_and_decorators/&t=Metaprogram%c3%a7%c3%a3o%20em%20Python%20com%20ASTs:%20criando%20um%20decorador%20com%20introspec%c3%a7%c3%a3o%20[Draft]" target=_blank rel=noopener class=share-btn-facebook><i class="fab fa-facebook"></i></a></li><li><a href="mailto:?subject=Metaprogram%c3%a7%c3%a3o%20em%20Python%20com%20ASTs:%20criando%20um%20decorador%20com%20introspec%c3%a7%c3%a3o%20[Draft]&body=/pt-br/post/python_ast_metaprogramming_with_introspection_and_decorators/" target=_blank rel=noopener class=share-btn-email><i class="fas fa-envelope"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?url=/pt-br/post/python_ast_metaprogramming_with_introspection_and_decorators/&title=Metaprogram%c3%a7%c3%a3o%20em%20Python%20com%20ASTs:%20criando%20um%20decorador%20com%20introspec%c3%a7%c3%a3o%20[Draft]" target=_blank rel=noopener class=share-btn-linkedin><i class="fab fa-linkedin-in"></i></a></li><li><a href="whatsapp://send?text=Metaprogram%c3%a7%c3%a3o%20em%20Python%20com%20ASTs:%20criando%20um%20decorador%20com%20introspec%c3%a7%c3%a3o%20[Draft]%20/pt-br/post/python_ast_metaprogramming_with_introspection_and_decorators/" target=_blank rel=noopener class=share-btn-whatsapp><i class="fab fa-whatsapp"></i></a></li><li><a href="https://service.weibo.com/share/share.php?url=/pt-br/post/python_ast_metaprogramming_with_introspection_and_decorators/&title=Metaprogram%c3%a7%c3%a3o%20em%20Python%20com%20ASTs:%20criando%20um%20decorador%20com%20introspec%c3%a7%c3%a3o%20[Draft]" target=_blank rel=noopener class=share-btn-weibo><i class="fab fa-weibo"></i></a></li></ul></div><div class="media author-card content-widget-hr"><img class="avatar mr-3 avatar-circle" src=/pt-br/author/bruno-messias/avatar_hu8c5dc81c7296f83357bec0b4ab814f69_6046_270x270_fill_lanczos_center_2.png alt="Bruno Messias"><div class=media-body><h5 class=card-title><a href=/>Bruno Messias</a></h5><h6 class=card-subtitle>Ph.D Candidate /Software Developer</h6><p class=card-text>Free-software enthusiast, researcher, and software developer. Currently, working in the field of Graphs, Complex Systems and Machine Learning.</p><ul class=network-icon aria-hidden=true><li><a href=mailto:devmessias@gmail.com><i class="fas fa-envelope"></i></a></li><li><a href=https://twitter.com/devmessias target=_blank rel=noopener><i class="fab fa-twitter"></i></a></li><li><a href=https://github.com/devmessias target=_blank rel=noopener><i class="fab fa-github"></i></a></li><li><a href=https://www.linkedin.com/in/bruno-messias-510553193/ target=_blank rel=noopener><i class="fab fa-linkedin"></i></a></li></ul></div></div><section id=comments><div id=disqus_thread></div><script>let disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='https://'+"devmessias"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section><div class="article-widget content-widget-hr"><h3>Relacionados</h3><ul><li><a href=/pt-br/post/python_decorator_that_exposes_locals/>An introspective python decorator using stack frames and the inspect module</a></li><li><a href=/pt-br/post/investigando_processos_e_bugs_strace_lsof_no_linux/>Dissecando processos e erros no Linux com o lsof e strace: casos para DevOps/MlOps</a></li><li><a href=/pt-br/post/edge_graph_filtering/>Grafos e filtragem de arestas I: conceitos e confus√µes</a></li><li><a href=/pt-br/post/random_matrix_portfolio/>Varia√ß√µes do teorema central do limite para matrizes aleat√≥rias.</a></li><li><a href=/pt-br/project/helios/>Helios: graph layout viz and streaming</a></li></ul></div></div></article></main></div></div></div><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.4.8/mermaid.min.js integrity="sha256-lyWCDMnMeZiXRi7Zl54sZGKYmgQs4izcT7+tKc+KUBk=" crossorigin=anonymous title=mermaid></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/r.min.js></script><script>const code_highlighting=true;</script><script>const isSiteThemeDark=false;</script><script>const search_config={"indexURI":"/pt-br/index.json","minLength":1,"threshold":0.3};const i18n={"no_results":"Sem resultados","placeholder":"Pesquisar...","results":"Resultados encontrados"};const content_type={'post':"Posts",'project':"Projetos",'publication':"Publica√ß√µes",'talk':"Palestras",'slides':"Slides"};</script><script id=search-hit-fuse-template type=text/x-template>
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script><script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin=anonymous></script><script id=dsq-count-scr src=https://devmessias.disqus.com/count.js async></script><script src=/js/academic.min.37431be2d92d7fb0160054761ab79602.js></script><div class=page-footer><div class=container><footer class=site-footer><p class=powered-by>Bruno Messias</p><p class=powered-by>Powered by the
<a href=https://sourcethemes.com/academic/ target=_blank rel=noopener>Academic theme</a> for
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a>.
<span class=float-right aria-hidden=true><a href=# class=back-to-top><span class=button_icon><i class="fas fa-chevron-up fa-2x"></i></span></a></span></p></footer></div></div><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cita√ß√£o</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i>Copiar</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i>Download</a><div id=modal-error></div></div></div></div></div></body></html>